# Cursor Rules for Confluence2Notion Extension

## Project Context

You are developing a Chrome/Edge browser extension called "Confluence2Notion" that:
1. Reads Confluence page content from the DOM (works with private/self-hosted instances)
2. Converts HTML content to Markdown using Turndown.js
3. Sends the content to Notion via the public API
4. Uses Manifest V3 architecture

## Tech Stack

- **Platform**: Chrome Extension (Manifest V3)
- **Language**: Vanilla JavaScript (ES2020+)
- **Libraries**: 
  - Turndown.js for HTML→Markdown conversion
  - turndown-plugin-gfm for tables and GFM support
- **APIs**: Notion API v1 (2022-06-28)
- **Storage**: Chrome Storage Sync API

## Code Style Guidelines

### JavaScript
- Use ES modules where possible
- Prefer `const` over `let`, avoid `var`
- Use async/await for asynchronous operations
- Use template literals for string interpolation
- Add JSDoc comments for functions
- Handle errors with try/catch and provide meaningful error messages

### File Organization
```
src/
├── background/     # Service worker only
├── content/        # Content scripts (DOM interaction)
├── popup/          # Popup UI files
├── lib/            # Third-party libraries and wrappers
└── utils/          # Shared utility functions
```

### Naming Conventions
- Files: kebab-case (e.g., `notion-client.js`)
- Functions: camelCase (e.g., `parseConfluencePage`)
- Constants: UPPER_SNAKE_CASE (e.g., `NOTION_API_VERSION`)
- Classes: PascalCase (e.g., `NotionClient`)

## Key Implementation Details

### Manifest V3 Requirements
- Use `service_worker` instead of `background.scripts`
- Use `action` instead of `browser_action`
- No inline scripts in HTML files
- Use `chrome.scripting.executeScript` for dynamic injection

### Content Script Patterns
```javascript
// Always check if we're on a Confluence page
function isConfluencePage() {
  return document.querySelector('#main-content') !== null ||
         document.querySelector('[data-testid="page-content"]') !== null;
}

// Use MutationObserver for dynamic content
const observer = new MutationObserver(callback);
observer.observe(document.body, { childList: true, subtree: true });
```

### Notion API Patterns
```javascript
// Always use this header set
const headers = {
  'Authorization': `Bearer ${token}`,
  'Content-Type': 'application/json',
  'Notion-Version': '2022-06-28'
};

// Handle rate limits
if (response.status === 429) {
  const retryAfter = response.headers.get('Retry-After') || 1;
  await sleep(retryAfter * 1000);
  // Retry request
}
```

### Markdown to Notion Block Conversion
When converting Markdown to Notion blocks, remember:
- Notion has a 2000 character limit per rich_text item
- Split long paragraphs into multiple text items
- Nested lists require proper parent-child relationships
- Code blocks need a `language` field (default to 'plain text')

## Common Pitfalls to Avoid

1. **Don't use `chrome.runtime.sendMessage` without checking for listeners**
   ```javascript
   // Bad
   chrome.runtime.sendMessage({ type: 'PARSE' });
   
   // Good
   chrome.runtime.sendMessage({ type: 'PARSE' }).catch(() => {
     console.log('No listener available');
   });
   ```

2. **Don't store sensitive data in localStorage**
   ```javascript
   // Bad - visible to other scripts
   localStorage.setItem('apiToken', token);
   
   // Good - encrypted by Chrome
   chrome.storage.sync.set({ apiToken: token });
   ```

3. **Don't assume DOM structure**
   ```javascript
   // Bad - will throw if element doesn't exist
   const title = document.querySelector('#title').textContent;
   
   // Good - null-safe
   const title = document.querySelector('#title')?.textContent || 'Untitled';
   ```

4. **Don't forget Notion block limits**
   - Max 100 blocks per API request
   - For large pages, batch the requests

## Testing Commands

```bash
# Load extension in Chrome
# 1. Go to chrome://extensions
# 2. Enable Developer mode
# 3. Click "Load unpacked"
# 4. Select the extension folder

# For development, use web-ext (optional)
npx web-ext run --target=chromium
```

## Reference: Confluence Selectors

```javascript
// Confluence Cloud (Atlassian hosted)
const cloudSelectors = {
  title: '[data-testid="title-text"] span',
  content: '[data-testid="page-content-container"]',
  body: '.ak-renderer-document',
};

// Confluence Server/Data Center (self-hosted)
const serverSelectors = {
  title: '#title-text',
  content: '#main-content .wiki-content',
  body: '.confluence-content-body',
};
```

## Reference: Notion Block Types

```javascript
const blockTypes = {
  paragraph: { type: 'paragraph', paragraph: { rich_text: [] } },
  heading_1: { type: 'heading_1', heading_1: { rich_text: [] } },
  heading_2: { type: 'heading_2', heading_2: { rich_text: [] } },
  heading_3: { type: 'heading_3', heading_3: { rich_text: [] } },
  bulleted_list_item: { type: 'bulleted_list_item', bulleted_list_item: { rich_text: [] } },
  numbered_list_item: { type: 'numbered_list_item', numbered_list_item: { rich_text: [] } },
  code: { type: 'code', code: { rich_text: [], language: 'plain text' } },
  quote: { type: 'quote', quote: { rich_text: [] } },
  divider: { type: 'divider', divider: {} },
  table: { type: 'table', table: { table_width: 0, children: [] } },
};
```

## When Generating Code

1. **Always include error handling** - Users may be on different Confluence versions
2. **Add console.log for debugging** - Use a `DEBUG` flag to toggle
3. **Make UI responsive** - Show loading states and progress
4. **Validate user input** - Check API token format, page ID format
5. **Provide fallbacks** - If one selector fails, try alternatives

## Prompt Templates for Development

### For implementing a new feature:
"Implement [feature] for the Confluence2Notion extension. Follow the existing code style and patterns. Include error handling and add JSDoc comments."

### For fixing bugs:
"Debug why [issue]. Check the DOM selectors, API response handling, and storage operations. Add appropriate error logging."

### For refactoring:
"Refactor [component] to be more modular and testable. Extract reusable functions and add type hints via JSDoc."
